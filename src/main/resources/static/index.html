<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Staff Biometric Attendance System</title>

  <style>
:root{
  --bg-start:#e0f2fe; --bg-end:#f0f9ff; --card:#fff;
  --blue-600:#0284c7; --blue-700:#0369a1; --green-500:#22c55e; --red-500:#ef4444;
  --muted:#64748b; --radius:16px;
}
*{box-sizing:border-box; margin:0; padding:0}
body{
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  background:linear-gradient(180deg,var(--bg-start),var(--bg-end));
  color:#0f172a; min-height:100vh; padding:20px;
}
.hero{text-align:center; margin:20px 0}
.hero-title{font-weight:800; font-size:48px; color:var(--blue-700); margin-bottom:8px}
.hero-sub{color:var(--muted); font-size:18px}
.container{max-width:900px; margin:0 auto}
.page{display:none}
.page.active{display:block}
.card{background:var(--card); border-radius:var(--radius); padding:28px; box-shadow:0 8px 24px rgba(0,0,0,0.08); margin-bottom:20px}
.card-title{font-size:32px; color:var(--blue-700); font-weight:700; margin-bottom:12px}
.card-sub{color:var(--muted); margin-bottom:20px}
.btn{cursor:pointer; border:0; padding:14px 24px; border-radius:10px; font-weight:600; font-size:16px; transition:all 0.3s}
.btn:hover{transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.15)}
.btn-blue{background:var(--blue-600); color:#fff}
.btn-blue:hover{background:var(--blue-700)}
.btn-green{background:var(--green-500); color:#fff}
.btn-green:hover{background:#16a34a}
.btn-red{background:var(--red-500); color:#fff}
.btn-red:hover{background:#dc2626}
.btn-outline{background:#fff; color:var(--blue-600); border:2px solid var(--blue-600)}
.btn-ghost{background:transparent; color:var(--muted); border:1px solid #e2e8f0}
.btn.big{padding:18px 24px; font-size:18px; width:100%}
.btn-stack{display:flex; flex-direction:column; gap:12px; margin-top:18px}
.btn-row{display:flex; gap:12px; flex-wrap:wrap; margin-top:16px}
.field{display:block; margin-top:16px}
.field-label{display:block; font-weight:600; margin-bottom:8px; color:#334155}
.field input{width:100%; padding:12px; border-radius:8px; border:2px solid #e2e8f0; font-size:16px}
.field input:focus{outline:none; border-color:var(--blue-600)}
.row{display:flex; gap:12px; align-items:center; margin-top:16px}
.upload-area{flex:1; border-radius:12px; padding:24px; border:3px dashed #cbd5e1; text-align:center; cursor:pointer; background:#f8fafc; transition:all 0.3s}
.upload-area:hover{border-color:var(--blue-600); background:#eff6ff}
.upload-area input{display:none}
.photo-preview{width:150px; height:150px; border-radius:12px; border:2px solid #e2e8f0; overflow:hidden; display:flex; align-items:center; justify-content:center; background:#f8fafc}
.photo-preview img{width:100%; height:100%; object-fit:cover}
.qr-preview{width:120px; height:120px; border-radius:12px; border:2px solid #e2e8f0; display:flex; align-items:center; justify-content:center; background:#fff}
.camera-container{position:relative; width:100%; max-width:640px; margin:0 auto}
#camera{width:100%; height:360px; border-radius:12px; background:#1e293b; object-fit:cover}
.camera-overlay{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:280px; height:280px; border:3px solid var(--green-500); border-radius:50%; pointer-events:none}
.status-message{margin-top:16px; padding:16px; border-radius:8px; text-align:center; font-weight:600}
.status-success{background:#dcfce7; color:#166534; border:2px solid #86efac}
.status-error{background:#fee2e2; color:#991b1b; border:2px solid #fca5a5}
.status-info{background:#dbeafe; color:#1e40af; border:2px solid #93c5fd}
.staff-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:16px; margin-top:20px}
.staff-card{background:#f8fafc; border-radius:12px; padding:16px; text-align:center; border:2px solid #e2e8f0}
.staff-photo{width:100px; height:100px; border-radius:50%; margin:0 auto 12px; border:3px solid var(--blue-600); overflow:hidden}
.staff-photo img{width:100%; height:100%; object-fit:cover}
.loading{display:inline-block; width:20px; height:20px; border:3px solid #fff; border-top-color:transparent; border-radius:50%; animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
@media (max-width:768px){
  .hero-title{font-size:36px}
  #camera{height:280px}
  .btn-row{flex-direction:column}
  .btn-row .btn{width:100%}
}
  </style>
</head>
<body>
  <div class="hero">
    <h1 class="hero-title">Staff Biometric Attendance</h1>
    <p class="hero-sub">Advanced Face Recognition System</p>
  </div>

  <main class="container">
    <section id="homePage" class="page active">
      <div class="card">
        <h2 class="card-title">Welcome</h2>
        <p class="card-sub">Select an option to continue</p>
        <div class="btn-stack">
          <button id="btnSignIn" class="btn btn-blue big">Sign In</button>
          <button id="btnSignOut" class="btn btn-green big">Sign Out</button>
          <button id="btnAddStaff" class="btn btn-outline big">Add New Staff</button>
          <button id="btnViewStaff" class="btn btn-ghost big">View All Staff</button>
        </div>
      </div>
    </section>

    <section id="addStaffPage" class="page">
      <div class="card">
        <h2 class="card-title">Add New Staff</h2>
        <p class="card-sub">Fill in the staff details and upload a photo</p>

        <label class="field">
          <span class="field-label">Full Name</span>
          <input id="staffName" type="text" placeholder="e.g. John Doe" required>
        </label>

        <label class="field">
          <span class="field-label">Employee ID</span>
          <input id="employeeId" type="text" placeholder="e.g. EMP001" required>
        </label>

        <label class="field">
          <span class="field-label">Designation</span>
          <input id="designation" type="text" placeholder="e.g. Sales Manager">
        </label>

        <div class="row">
          <label class="upload-area">
            <input id="photoInput" type="file" accept="image/*">
            <div>
              <div style="font-size:48px">ðŸ“·</div>
              <div style="margin-top:8px; color:var(--blue-600); font-weight:600">Upload Photo</div>
              <div style="margin-top:4px; font-size:14px; color:var(--muted)">Click to select</div>
            </div>
          </label>

          <div id="photoPreview" class="photo-preview"></div>
        </div>

        <div id="qrSection" style="display:none; margin-top:20px; text-align:center">
          <p style="font-weight:600; margin-bottom:12px">QR Code for Quick Scan</p>
          <div id="qrPreview" class="qr-preview" style="margin:0 auto"></div>
        </div>

        <div id="addStatus"></div>

        <div class="btn-row">
          <button id="btnSaveStaff" class="btn btn-blue">Add Staff</button>
          <button id="btnBackFromAdd" class="btn btn-ghost">Back</button>
        </div>
      </div>
    </section>

    <section id="scanPage" class="page">
      <div class="card">
        <h2 class="card-title" id="scanTitle">Scan Attendance</h2>
        <p class="card-sub">Position your face in the camera view</p>

        <div class="camera-container">
          <video id="camera" autoplay playsinline muted></video>
          <div class="camera-overlay"></div>
        </div>

        <div id="scanStatus"></div>

        <div class="btn-row">
          <button id="btnCapture" class="btn btn-blue">Capture & Match</button>
          <button id="btnScanQR" class="btn btn-outline">Scan QR Code</button>
          <button id="btnBackFromScan" class="btn btn-ghost">Back</button>
        </div>
      </div>
    </section>

    <section id="viewStaffPage" class="page">
      <div class="card">
        <h2 class="card-title">All Staff Members</h2>
        <p class="card-sub">Registered staff list</p>

        <div id="staffList" class="staff-grid"></div>

        <div class="btn-row" style="margin-top:20px">
          <button id="btnBackFromView" class="btn btn-ghost">Back</button>
        </div>
      </div>
    </section>
  </main>

  <script>
const API_BASE = 'http://localhost:8080/api';
let cameraStream = null;
let currentMode = null;
let uploadedPhotoData = null;

const pages = {
  home: document.getElementById('homePage'),
  add: document.getElementById('addStaffPage'),
  scan: document.getElementById('scanPage'),
  view: document.getElementById('viewStaffPage')
};

function showPage(name, mode) {
  Object.values(pages).forEach(p => p.classList.remove('active'));
  if (pages[name]) pages[name].classList.add('active');
  currentMode = mode || null;

  if (name === 'scan') {
    const title = document.getElementById('scanTitle');
    title.textContent = currentMode === 'signin' ? 'Sign In - Face Recognition' : 'Sign Out - Face Recognition';
    openCamera();
  } else {
    stopCamera();
  }

  if (name === 'view') {
    loadAllStaff();
  }
}

function showStatus(elementId, message, type) {
  const el = document.getElementById(elementId);
  el.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
}

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('btnSignIn').addEventListener('click', () => showPage('scan', 'signin'));
  document.getElementById('btnSignOut').addEventListener('click', () => showPage('scan', 'signout'));
  document.getElementById('btnAddStaff').addEventListener('click', () => showPage('add'));
  document.getElementById('btnViewStaff').addEventListener('click', () => showPage('view'));

  document.getElementById('btnBackFromAdd').addEventListener('click', () => showPage('home'));
  document.getElementById('btnBackFromScan').addEventListener('click', () => showPage('home'));
  document.getElementById('btnBackFromView').addEventListener('click', () => showPage('home'));

  document.getElementById('btnSaveStaff').addEventListener('click', saveStaff);
  document.getElementById('btnCapture').addEventListener('click', captureAndMatch);
  document.getElementById('btnScanQR').addEventListener('click', scanQRCode);

  document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
});

async function handlePhotoUpload(e) {
  const file = e.target.files[0];
  if (!file) return;

  uploadedPhotoData = await fileToBase64(file);
  const preview = document.getElementById('photoPreview');
  preview.innerHTML = `<img src="${uploadedPhotoData}" alt="Preview">`;
}

async function saveStaff() {
  const name = document.getElementById('staffName').value.trim();
  const employeeId = document.getElementById('employeeId').value.trim();
  const designation = document.getElementById('designation').value.trim();

  if (!name || !employeeId) {
    showStatus('addStatus', 'Please enter Name and Employee ID', 'error');
    return;
  }

  if (!uploadedPhotoData) {
    showStatus('addStatus', 'Please upload a photo for face recognition', 'error');
    return;
  }

  const staff = {
    name,
    employeeId,
    designation,
    photoBase64: uploadedPhotoData
  };

  showStatus('addStatus', 'Saving staff data to database...', 'info');

  try {
    const res = await fetch(`${API_BASE}/staff`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(staff)
    });

    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(errorText || 'Failed to save staff');
    }

    const saved = await res.json();

    showStatus('addStatus', `Staff ${employeeId} added successfully! All data stored in MongoDB.`, 'success');

    const qrSection = document.getElementById('qrSection');
    qrSection.style.display = 'block';
    const qrPreview = document.getElementById('qrPreview');
    qrPreview.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(employeeId)}&size=120x120" alt="QR">`;

    document.getElementById('staffName').value = '';
    document.getElementById('employeeId').value = '';
    document.getElementById('designation').value = '';
    document.getElementById('photoInput').value = '';
    document.getElementById('photoPreview').innerHTML = '';
    uploadedPhotoData = null;

    setTimeout(() => {
      qrSection.style.display = 'none';
    }, 5000);

  } catch (err) {
    showStatus('addStatus', 'Error: ' + err.message, 'error');
  }
}

async function openCamera() {
  const cam = document.getElementById('camera');
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: 640, height: 480 }
    });
    cam.srcObject = cameraStream;
    await cam.play();
  } catch (err) {
    console.error('Camera error:', err);
    showStatus('scanStatus', 'Camera access denied. Please allow camera permissions.', 'error');
  }
}

function stopCamera() {
  const cam = document.getElementById('camera');
  if (cameraStream) {
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
  }
  if (cam) cam.srcObject = null;
}

async function captureAndMatch() {
  const cam = document.getElementById('camera');
  if (!cam || !cameraStream) {
    showStatus('scanStatus', 'Camera not ready. Please wait...', 'error');
    return;
  }

  showStatus('scanStatus', 'Capturing and matching face with database...', 'info');

  const canvas = document.createElement('canvas');
  canvas.width = cam.videoWidth || 640;
  canvas.height = cam.videoHeight || 480;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(cam, 0, 0, canvas.width, canvas.height);
  const capturedImage = canvas.toDataURL('image/jpeg', 0.8);

  try {
    const res = await fetch(`${API_BASE}/staff`);
    if (!res.ok) throw new Error('Failed to load staff from database');

    const staffList = await res.json();

    if (!staffList || staffList.length === 0) {
      showStatus('scanStatus', 'No staff registered in database. Please add staff first.', 'error');
      return;
    }

    let bestMatch = { employeeId: null, name: null, score: Infinity };

    for (const staff of staffList) {
      if (!staff.photoBase64) continue;
      const score = await compareImages(capturedImage, staff.photoBase64);
      if (score < bestMatch.score) {
        bestMatch = { employeeId: staff.employeeId, name: staff.name, score };
      }
    }

    const threshold = 90;
    if (bestMatch.score < threshold && bestMatch.employeeId) {
      showStatus('scanStatus', `Match found: ${bestMatch.name} (${bestMatch.employeeId}) - Recording attendance...`, 'success');
      await recordAttendance(bestMatch.employeeId);
    } else {
      showStatus('scanStatus', `No match found. Please try again or use QR code. (Best score: ${bestMatch.score.toFixed(1)})`, 'error');
    }

  } catch (err) {
    showStatus('scanStatus', 'Error: ' + err.message, 'error');
  }
}

async function compareImages(img1Data, img2Data, size = 100) {
  return new Promise((resolve) => {
    const img1 = new Image();
    const img2 = new Image();
    let loaded = 0;

    function onLoad() {
      loaded++;
      if (loaded < 2) return;

      const canvas = document.createElement('canvas');
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');

      ctx.clearRect(0, 0, size, size);
      ctx.drawImage(img1, 0, 0, size, size);
      const data1 = ctx.getImageData(0, 0, size, size).data;

      ctx.clearRect(0, 0, size, size);
      ctx.drawImage(img2, 0, 0, size, size);
      const data2 = ctx.getImageData(0, 0, size, size).data;

      let sumSq = 0;
      for (let i = 0; i < data1.length; i += 4) {
        const lum1 = 0.299 * data1[i] + 0.587 * data1[i+1] + 0.114 * data1[i+2];
        const lum2 = 0.299 * data2[i] + 0.587 * data2[i+1] + 0.114 * data2[i+2];
        sumSq += Math.pow(lum1 - lum2, 2);
      }

      const rmse = Math.sqrt(sumSq / (size * size));
      resolve(rmse);
    }

    img1.crossOrigin = 'Anonymous';
    img2.crossOrigin = 'Anonymous';
    img1.onload = onLoad;
    img2.onload = onLoad;
    img1.src = img1Data;
    img2.src = img2Data;
  });
}

async function recordAttendance(employeeId) {
  const endpoint = currentMode === 'signin' ? 'signin' : 'signout';
  try {
    const res = await fetch(`${API_BASE}/attendance/${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ employeeId })
    });

    if (!res.ok) {
      const errorText = await res.text();
      throw new Error(errorText);
    }

    const data = await res.json();
    const action = currentMode === 'signin' ? 'Signed In' : 'Signed Out';
    showStatus('scanStatus', `${action} successfully at ${new Date(data.timestamp).toLocaleTimeString()}`, 'success');

    setTimeout(() => {
      stopCamera();
      showPage('home');
    }, 2000);

  } catch (err) {
    showStatus('scanStatus', 'Error recording attendance: ' + err.message, 'error');
  }
}

function scanQRCode() {
  const employeeId = prompt('Enter Employee ID from QR code:');
  if (!employeeId) return;

  showStatus('scanStatus', 'Verifying employee...', 'info');

  fetch(`${API_BASE}/staff/${employeeId}`)
    .then(res => {
      if (!res.ok) throw new Error('Employee not found');
      return res.json();
    })
    .then(staff => {
      showStatus('scanStatus', `Employee verified: ${staff.name} - Recording attendance...`, 'success');
      return recordAttendance(employeeId);
    })
    .catch(err => {
      showStatus('scanStatus', 'Error: ' + err.message, 'error');
    });
}

async function loadAllStaff() {
  const listEl = document.getElementById('staffList');
  listEl.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted)">Loading staff...</div>';

  try {
    const res = await fetch(`${API_BASE}/staff`);
    if (!res.ok) throw new Error('Failed to load staff');

    const staffList = await res.json();
    if (!staffList || staffList.length === 0) {
      listEl.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted)">No staff registered yet</div>';
      return;
    }

    listEl.innerHTML = staffList.map(staff => {
      return `
      <div class="staff-card">
        <div class="staff-photo">
          ${staff.photoBase64 ? `<img src="${staff.photoBase64}" alt="${staff.name}">` : '<div style="color:var(--muted); font-size:12px">No Photo<br>Available</div>'}
        </div>
        <div style="font-weight:700; color:#1e293b">${staff.name}</div>
        <div style="color:var(--muted); font-size:14px; margin-top:4px">${staff.employeeId}</div>
        <div style="color:var(--blue-600); font-size:13px; margin-top:4px">${staff.designation || 'N/A'}</div>
        <div style="color:var(--muted); font-size:12px; margin-top:4px">Created: ${new Date(staff.createdAt).toLocaleDateString()}</div>
      </div>
    `}).join('');

  } catch (err) {
    listEl.innerHTML = `<div style="text-align:center; padding:20px; color:var(--red-500)">Error: ${err.message}</div>`;
  }
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}
  </script>
</body>
</html>
